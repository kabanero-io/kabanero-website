language: ruby
rvm:
  - 2.6.3

env:
  global:
    - DOCS_=hi
  matrix:

stages:
  - name: Unit Tests
    if: type IN (push, pull_request, api) 
  - name: Fork Deploy
    if: (type IN (push, api)) AND ($TRAVIS_REPO_SLUG != kabanero-io/kabanero-website)
  - name: Production Deploy
    if: (type IN (push, api) )AND (fork == false)
    condition: $TRAVIS_REPO_SLUG = kabanero-io/kabanero-website

jobs:
  include:
    - stage: "Unit Tests"
      name: "Running Unit Tests"
      install:
          - bundle install
          - npm install eslint --save-dev
          - ./node_modules/.bin/eslint src/main/content/_assets/js/*.js
      script:
        - ./scripts/build_jekyll_maven.sh
        
    - stage: "Fork Deploy"
      name: "Deploy to IBM CF from forked repository"
      env: JEKYLL_ENV=development
      install: 
        - bundle install
      skip_cleanup: true
      on:
        repo: $TRAVIS_REPO_SLUG
        branch: $TRAVIS_BRANCH
      script: 
        - curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        - ./scripts/build_jekyll_maven.sh        
        - ./scripts/ibmcloud-cf-push.sh 

    - stage: "Production Deploy"
      name: "Production deploy"
      env: JEKYLL_ENV=pro
      install: 
        - bundle install
      skip_cleanup: true
      on:
        repo: kabanero-io/kabanero-website
        branch: $TRAVIS_BRANCH
      script: 
        - curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        - ./scripts/build_jekyll_maven.sh    
        - ./scripts/ibmcloud-cf-push.sh 


# before_deploy: 
#  - curl -fsSL https://clis.cloud.ibm.com/install/linux | sh 

# deploy:
#   - provider: script
#     skip_cleanup: true
#     on:
#      tags: true
#     script: "./scripts/ibmcloud-cf-push.sh kabanero-prod"
#   - provider: script
#     skip_cleanup: true
#     on:
#       repo: $TRAVIS_REPO_SLUG
#       branch: $TRAVIS_BRANCH
#       condition: "$TRAVIS_EVENT_TYPE = api"
#     script: "./scripts/ibmcloud-cf-push.sh ${TRAVIS_REPO_SLUG%/*}"
